kind: pipeline
name: default
steps:
- name: build_war
  image: maven:alpine
  commands:
  - mvn --batch-mode clean install
- name: deploy_war 
  image: maven
  settings:
    url:
      from_secret: ARTIFACTORY_URL
    username:
      from_secret: ARTIFACTORY_USER
    password:
      from_secret: ARTIFACTORY_PASSWORD
    repo_key:
      from_secret: REPOSITORY_KEY
  commands:
    - curl -fL https://getcli.jfrog.io | sh
    - ./jfrog rt config --url=$ARTIFACTORY_URL --user=$ARTIFACTORY_USER --password=$ARTIFACTORY_PASSWORD
    - ./jfrog rt c show
    - export M2_HOME=/usr/share/maven
    - sed -i 's,REPOSITORY_KEY,'"$REPOSITORY_KEY"',g' configuration.yml
    - ./jfrog rt mvn "clean install" configuration.yml --build-name=Drone_Maven_demo --build-number=1.1.0
    - ./jfrog rt bce Drone_Maven_demo 1.1.0
    - ./jfrog rt bp Drone_Maven_demo 1.1.0
